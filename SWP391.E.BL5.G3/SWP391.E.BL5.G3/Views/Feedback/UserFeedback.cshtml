@using static SWP391.E.BL5.G3.Controllers.FeedbackController
@model UserFeedbackViewModel

@{
    Layout = "/Views/Shared/_HomeLayout.cshtml";
    ViewData["Title"] = "Tour Feedback";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6>Tour Feedback</h6>
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                    <form id="tourFeedbackForm" asp-action="SubmitTourFeedback" method="post">
                        <input type="hidden" name="TourId" value="@Model.TourId" />
                        @if (Model.TourId != null)
                        {
                            <!-- Hotel Feedback -->
                            <div class="form-group mb-4">
                                <label class="form-label">Hotel Rating</label>
                                <div class="star-rating" data-field="HotelRating">
                                    <span data-value="1" class="star">★</span>
                                    <span data-value="2" class="star">★</span>
                                    <span data-value="3" class="star">★</span>
                                    <span data-value="4" class="star">★</span>
                                    <span data-value="5" class="star">★</span>
                                </div>
                                <input type="hidden" name="HotelRating" id="HotelRating" />
                                <textarea name="HotelFeedbackContent" class="form-control" placeholder="Your feedback about the hotel" required></textarea>
                            </div>

                            <!-- Vehicle Feedback -->
                            <div class="form-group mb-4">
                                <label class="form-label">Vehicle Rating</label>
                                <div class="star-rating" data-field="VehicleRating">
                                    <span data-value="1" class="star">★</span>
                                    <span data-value="2" class="star">★</span>
                                    <span data-value="3" class="star">★</span>
                                    <span data-value="4" class="star">★</span>
                                    <span data-value="5" class="star">★</span>
                                </div>
                                <input type="hidden" name="VehicleRating" id="VehicleRating" />
                                <textarea name="VehicleFeedbackContent" class="form-control" placeholder="Your feedback about the vehicle" required></textarea>
                            </div>

                            <!-- Tour Guide Feedback -->
                            <div class="form-group mb-4">
                                <label class="form-label">Tour Guide Rating</label>
                                <div class="star-rating" data-field="GuideRating">
                                    <span data-value="1" class="star">★</span>
                                    <span data-value="2" class="star">★</span>
                                    <span data-value="3" class="star">★</span>
                                    <span data-value="4" class="star">★</span>
                                    <span data-value="5" class="star">★</span>
                                </div>
                                <input type="hidden" name="GuideRating" id="GuideRating" />
                                <textarea name="GuideFeedbackContent" class="form-control" placeholder="Your feedback about the tour guide" required></textarea>
                            </div>

                            <!-- Restaurant Feedback -->
                            <div class="form-group mb-4">
                                <label class="form-label">Restaurant Rating</label>
                                <div class="star-rating" data-field="RestaurantRating">
                                    <span data-value="1" class="star">★</span>
                                    <span data-value="2" class="star">★</span>
                                    <span data-value="3" class="star">★</span>
                                    <span data-value="4" class="star">★</span>
                                    <span data-value="5" class="star">★</span>
                                </div>
                                <input type="hidden" name="RestaurantRating" id="RestaurantRating" />
                                <textarea name="RestaurantFeedbackContent" class="form-control" placeholder="Your feedback about the restaurant" required></textarea>
                            </div>

                            <!-- Tour Feedback (Average Rating) -->
                            <div class="form-group mb-4">
                                <label class="form-label">Overall Tour Rating</label>
                                <input type="hidden" name="TourRating" id="TourRating" class="form-control" readonly />
                                <textarea name="TourFeedbackContent" class="form-control" placeholder="Your feedback about the tour" required></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">Submit Feedback</button>
                                <a href="@Url.Action("Index", "Home")" class="btn btn-secondary">Cancel</a>
                            </div>
                        }
                        else 
                        {
                            if (Model.HotelId != null)
                            {
                                <div class="form-group mb-4">
                                    <label class="form-label">Hotel Rating</label>
                                    <div class="star-rating" data-field="HotelRating">
                                        <span data-value="1" class="star">★</span>
                                        <span data-value="2" class="star">★</span>
                                        <span data-value="3" class="star">★</span>
                                        <span data-value="4" class="star">★</span>
                                        <span data-value="5" class="star">★</span>
                                    </div>
                                    <input type="hidden" name="HotelRating" id="HotelRating" />
                                    <textarea name="HotelFeedbackContent" class="form-control" placeholder="Your feedback about the hotel" required></textarea>
                                </div>

                                <!-- Submit Button -->
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Submit Feedback</button>
                                    <a href="@Url.Action("Index", "Home")" class="btn btn-secondary">Cancel</a>
                                </div>
                            }

                            if(Model.RestaurantId != null)
                            {
                                <div class="form-group mb-4">
                                    <label class="form-label">Restaurant Rating</label>
                                    <div class="star-rating" data-field="RestaurantRating">
                                        <span data-value="1" class="star">★</span>
                                        <span data-value="2" class="star">★</span>
                                        <span data-value="3" class="star">★</span>
                                        <span data-value="4" class="star">★</span>
                                        <span data-value="5" class="star">★</span>
                                    </div>
                                    <input type="hidden" name="RestaurantRating" id="RestaurantRating" />
                                    <textarea name="RestaurantFeedbackContent" class="form-control" placeholder="Your feedback about the restaurant" required></textarea>
                                </div>

                                <!-- Submit Button -->
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Submit Feedback</button>
                                    <a href="@Url.Action("Index", "Home")" class="btn btn-secondary">Cancel</a>
                                </div>
                            }
                            if(Model.VehicleId != null)
                            {
                                <div class="form-group mb-4">
                                    <label class="form-label">Vehicle Rating</label>
                                    <div class="star-rating" data-field="VehicleRating">
                                        <span data-value="1" class="star">★</span>
                                        <span data-value="2" class="star">★</span>
                                        <span data-value="3" class="star">★</span>
                                        <span data-value="4" class="star">★</span>
                                        <span data-value="5" class="star">★</span>
                                    </div>
                                    <input type="hidden" name="VehicleRating" id="VehicleRating" />
                                    <textarea name="VehicleFeedbackContent" class="form-control" placeholder="Your feedback about the vehicle" required></textarea>
                                </div>

                                <!-- Submit Button -->
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Submit Feedback</button>
                                    <a href="@Url.Action("Index", "Home")" class="btn btn-secondary">Cancel</a>
                                </div>
                            }
                        }
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const starGroups = document.querySelectorAll('.star-rating');

    starGroups.forEach(group => {
        const stars = group.querySelectorAll('.star');
        const ratingInput = document.getElementById(group.dataset.field);
        let currentRating = 0;

        stars.forEach(star => {
            star.addEventListener('mouseover', () => {
                const ratingValue = star.getAttribute('data-value');
                highlightStars(stars, ratingValue);
            });

            star.addEventListener('mouseleave', () => {
                clearHighlight(stars);
                if (currentRating > 0) {
                    highlightStars(stars, currentRating);
                }
            });

            star.addEventListener('click', (event) => {
                const ratingValue = getStarRating(event);
                currentRating = ratingValue;
                ratingInput.value = formatRating(ratingValue); // Chuyển đổi định dạng khi gán vào input
                highlightStars(stars, ratingValue);
                updateOverallRating();
            });
        });
    });

    function highlightStars(stars, rating) {
        stars.forEach(star => {
            star.classList.remove('full');
            const starValue = parseFloat(star.getAttribute('data-value'));
            if (starValue <= Math.floor(rating)) {
                star.classList.add('full');
            } else if (starValue === Math.ceil(rating) && !Number.isInteger(rating)) {
                star.classList.add('half'); // Thêm class cho nửa sao
            }
        });
    }

    function clearHighlight(stars) {
        stars.forEach(star => {
            star.classList.remove('full');
            star.classList.remove('half'); // Xóa class nửa sao
        });
    }

    function getStarRating(event) {
        const star = event.target;
        const starValue = parseFloat(star.getAttribute('data-value'));

        const starWidth = star.offsetWidth;
        const clickX = event.clientX - star.getBoundingClientRect().left;

        // Kiểm tra lựa chọn nửa sao
        if (clickX < starWidth / 2) {
            return starValue - 0.5; // Đánh giá nửa sao
        }
        return starValue; // Đánh giá sao đầy đủ
    }

    function updateOverallRating() {
        const hotelRating = parseFloat(document.getElementById('HotelRating').value.replace(',', '.')) || 0;
        const vehicleRating = parseFloat(document.getElementById('VehicleRating').value.replace(',', '.')) || 0;
        const guideRating = parseFloat(document.getElementById('GuideRating').value.replace(',', '.')) || 0;
        const restaurantRating = parseFloat(document.getElementById('RestaurantRating').value.replace(',', '.')) || 0;

        // Tính điểm trung bình
        const averageRating = (hotelRating + vehicleRating + guideRating + restaurantRating) / 4;

        // Hiển thị điểm trung bình với định dạng 4,5
        document.getElementById('TourRating').value = formatRating(averageRating);

        // Cập nhật các trường điểm riêng lẻ với định dạng 4,5
        document.getElementById('HotelRating').value = formatRating(hotelRating);
        document.getElementById('VehicleRating').value = formatRating(vehicleRating);
        document.getElementById('GuideRating').value = formatRating(guideRating);
        document.getElementById('RestaurantRating').value = formatRating(restaurantRating);
    }

    function formatRating(rating) {
        return rating.toFixed(1).replace('.', ',');
    }
</script>


<style>
    .star {
        font-size: 30px;
        cursor: pointer;
        color: lightgray;
    }

        .star.full {
            color: gold;
        }

        .star.half {
            color: gold;
            background: linear-gradient(90deg, gold 50%, lightgray 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
</style>
